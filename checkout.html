<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://proagency.github.io/custom-checkout/script.css" />
    <style>html,body{margin:0}</style>
  </head>
  <body>
    <div id="xilbee-root" style="max-width:640px;margin:20px auto;"></div>

    <script src="https://proagency.github.io/custom-checkout/script.js" defer></script>

    <script>
      (function () {
        function getParam(name) {
          var hash = location.hash && location.hash.startsWith('#') ? location.hash.slice(1) : '';
          var fromHash = hash ? new URLSearchParams(hash).get(name) : null;
          var fromSearch = new URLSearchParams(location.search).get(name);
          return fromHash || fromSearch;
        }
        function decodeB64Json(b64) {
          try { return JSON.parse(decodeURIComponent(escape(atob(b64)))); } catch (e) { return null; }
        }
        function start(cfg) {
          var mount = '#xilbee-root';
          if (!cfg) {
            document.querySelector(mount).innerHTML =
              "<div class='card checkout'><div class='err'>No config provided.</div></div>";
            return;
          }
          function run() {
            if (window.renderCheckout) {
              window.renderCheckout(cfg, { mount });
            } else {
              // wait up to ~5s if script.js is still loading
              var tries = 0, t = setInterval(function () {
                if (window.renderCheckout || ++tries > 160) {
                  clearInterval(t);
                  window.renderCheckout && window.renderCheckout(cfg, { mount });
                }
              }, 30);
            }
          }
          if (document.readyState === 'complete') run();
          else window.addEventListener('load', run);
        }

        var b64 = getParam('cfg');
        var cfgurl = new URLSearchParams(location.search).get('cfgurl');

        if (b64) start(decodeB64Json(b64));
        else if (cfgurl) fetch(cfgurl, { credentials: 'omit' }).then(r => r.json()).then(start).catch(() => start(null));
        else start(null);
      })();
    </script>
  </body>
</html>
